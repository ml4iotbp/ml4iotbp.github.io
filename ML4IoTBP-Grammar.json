{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Data sources YAML grammar",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "process-context": {
      "type": "object",
      "$ref": "#/definitions/processContext"
    },
    "process-data-sources": {
      "type": "object",
      "$ref": "#/definitions/processDataSource"
    },
    "iot-data-sources": {
      "type": "object",
      "patternProperties":{
        "^config[0-9]*$":{"$ref": "#/definitions/iotDataSourceWithConfig"},
         "^(?!config$)[A-Za-z_][A-Za-z0-9_-]*$": {"$ref": "#/definitions/iotDataSource"}
      }
    },
    "features": {
      "type": "object",
      "$ref": "#/definitions/features"
    },
    "dataset": {
      "type": "object",
      "$ref": "#/definitions/dataset"
    },
    "models": {
      "type": "object",
      "$ref": "#/definitions/models"
    },
    "runtime-predictions": {
      "type": "object",
      "$ref": "#/definitions/runtime-predictions"
    }
  },
  "anyOf":[
    {
        "required": ["process-data-sources","process-context"]
    },
    {
        "required": ["iot-data-sources"]  
    },
    {
        "required": ["features"]  
    },
    {
        "required": ["dataset"]  
    },
    {
        "required": ["models"]  
    },
    {
        "required": ["runtime-predictions"]  
    }
  ],

  "definitions": {
    "runtime-predictions":{
      "type": "object",
      "additionalProperties": false,
      "patternProperties": {
        "^[A-Za-z_][A-Za-z0-9_-]+$":{
          "type": "object",
          "additionalProperties": false,
          "properties":{
             "model": { "type": "string", "minLength": 1 },
             "trigger":{
                "type": "object",
                "additionalProperties": false,
                "properties":{
                  "type": { "type": "string", "minLength": 1 },
                  "every": { "type": "string", "minLength": 1 },
                  "first": { 
                      "type": "object",
                      "additionalProperties": false,
                      "patternProperties": {
                        "^[A-Za-z_][A-Za-z0-9_-]+$":{ "type": "string", "minLength": 1 }
                      }
                  }
                }
             },
             "inputFeatures":{
                "type": "array",
                "items": {"type":"string", "pattern":"^[A-Za-z_][A-Za-z0-9_-]+$" }
             },
             "output":{}
          }
        }
      }
    },

    "models":{
      "type": "object",
      "additionalProperties": false,
      "patternProperties": {
        "^[A-Za-z_][A-Za-z0-9_-]+$":{
          "type": "object",
          "additionalProperties": false,
          "properties":{
            "algorithm": { "type": "string", "minLength": 1 },
            "learning-type": { "type": "string", "enum": ["Supervised","Unsupervised"] },
            "dataset": { "type": "string", "minLength": 1 },
            "training":{
              "type": "object",
              "additionalProperties": false,
              "properties":{
                  "type": { "type": "string", "enum": ["Batch","Incremental"] },
                  "metrics":{
                    "type": "array",
                    "items": { "type": "string", "enum": ["accuracy","precision","f1","roc_auc","confusion_matrix","mae","mse","rmse","silhouette","davies_bouldin","calinski_harabasz","anomaly_rate"] }
                  },
                  "schedule":{
                    "type": "object",
                    "additionalProperties": false,
                    "properties":{
                      "type": { "type": "string", "enum": ["Periodic","Event-Based"] },
                      "every": { "type": "string", "minLength": 1 },
                      "events": {
                        "type":"array",
                        "items": {
                          "type":"object",
                          "additionalProperties": false,
                          "properties":{
                            "element-id": { "type": "string", "minLength": 1 },
                            "event": { "type": "string", "minLength": 1 }
                          }
                        }
                      }
                    },
                    "oneOf": [
                      { 
                        "properties":{ "type": {"const": "Periodic" }},
                        "required": ["every"], 
                        "not": { "required": ["events"] } },
                      { 
                        "properties":{ "type": {"const": "Event-Based" }},
                        "required": ["events"], 
                        "not": { "required": ["every"] } }
                    ]
                  } 
              }
            },
            "hyperparameters":{
              "type":"object",
              "additionalProperties": false,
              "patternProperties": {
                  "^[A-Za-z_][A-Za-z0-9_-]+$": {
                     "oneOf": [
                           {"type": "string", "minLength": 1},
                           {"type": "number"}
                     ]
                    }
              }
            }
          }
        }
      }
    },

    "dataset":{
        "type": "object",
        "additionalProperties": false,
        "patternProperties": {
              "^[A-Za-z_][A-Za-z0-9_-]+$": { 
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "label": {
                                "type": "object",
                                "additionalProperties": false,
                                "minProperties": 1,
                                "maxProperties": 1,
                                "patternProperties": {
                                  "^[A-Za-z][A-Za-z0-9]*$": { "type": "string", "pattern": "^[A-Za-z_][A-Za-z0-9_-]*$" }
                                }
                    },
                    "sampling-point":{"$ref": "#/definitions/anchor"},
                    "data": { 
                        "type": "array",
                        "minItems": 1,
                        "items": { 
                            "oneOf": [
                              {
                                "type": "object",
                                "additionalProperties": false,
                                "patternProperties": {
                                  "^[A-Za-z][A-Za-z0-9]*$": { "type": "string", "pattern": "^[A-Za-z_][A-Za-z0-9_-]*$" }
                                }
                              },
                              {
                                "type": "object",
                                "additionalProperties": false,
                                "patternProperties": {
                                  "^[A-Za-z_][A-Za-z0-9_-]*$":{ 
                                      "type": "array",
                                      "minItems": 2,
                                      "items":{
                                        "type": "object",
                                        "additionalProperties": false,
                                        "patternProperties": {
                                          "^[A-Za-z][A-Za-z0-9]*$": { "type": "string", "pattern": "^[A-Za-z_][A-Za-z0-9_-]*$" }
                                        }
                                      }
                                  }
                                }

                              }
                            ]
                        }
                    },
                    "train-ratio": { "type": "number", "minimum": 0, "maximum": 1 },
                    "val-ratio": { "type": "number", "minimum": 0, "maximum": 1 },
                    "test-ratio": { "type": "number", "minimum": 0, "maximum": 1 }

                  }
              }
        }
    },

    "features":{
        "type": "object",
        "additionalProperties": false,
        "patternProperties": {
              "^[A-Za-z_][A-Za-z0-9_-]+$": { "$ref": "#/definitions/featureDef" }
        }
    },

    "featureDef":{
      "type": "object",
      "additionalProperties": false,
      "required": ["from", "operation"],
      "properties": {
          "from": { "type": "string", "minLength": 1 },
          "label": { "type": "string", "minLength": 1 },
          "operation": {
            "type": "string",
            "enum": ["avg","min","max","count","sum","substract","latest_value","include","future_event_exists"]
          },
          "fields": {"type": "array", "minItems": 1, "items": { "type": "string", "minLength": 1} },
          "field": { "type": "string", "minLength": 1},
          "window": { "type": "string", "minLength": 1 },
          "anchor": { "$ref": "#/definitions/anchor" },
          "target-type": {
            "type": "string",
            "enum": ["binary", "multiclass", "regression"]
          },
          "positive-class": {
            "description": "Used when target-type is binary.",
            "type": ["boolean", "string", "number"]
          }
      },
      "oneOf": [
        { "required": ["fields"], "not": { "required": ["field"] } },
        { "required": ["field"], "not": { "required": ["fields"] } }
      ]
    },

    "anchor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["element", "event"],
      "properties": {
        "element": { "type": "string", "pattern":"^[A-Za-z_][A-Za-z0-9_-]+$" },
        "event": {
          "type": "string",
          "minLength": 1,
          "enum": ["started", "completed", "bacteria_detected"]
        }
      }
    },

    "iotDataSourceWithConfig":{
      "type": "object",
      "required": ["paradigm"],
      "properties":{
          "format": { "type": "string", "pattern": "^application\\/[A-Za-z_][A-Za-z0-9_-]+$" },
          "schema": { "$ref": "#/definitions/variables" },
          "paradigm": { "type": "string", "enum": ["MessageOriented","HTTPCompliant"]},
          "protocol": { "type": "string", "enum": ["AMQP","MQTT","STOMP","XMPP","Kafka"]},
          "broker": { "type": "string", "enum": ["Kafka", "RabbitMQ", "Mosquitto", "EMQX", "hiveMQ"]},
          "method": { "type": "string", "enum": ["GET","POST","PUT","PATCH","DELETE"]},
          "sampling-time":{ "type": "string", "minLength": 1 }   
      },
    
      "patternProperties": {
        "[A-Za-z_][A-Za-z0-9_-]*$": {
          "type": "object",
          "additionalProperties": false,
          "required": ["schema"],
          "properties": {
            "format": { "type": "string", "pattern": "^application\\/[A-Za-z_][A-Za-z0-9_-]+$"},          
            "schema": { "$ref": "#/definitions/variables" },

            "paradigm": { "type": "string", "enum": ["MessageOriented", "HTTPCompliant"] },
            "protocol": { "type": "string", "enum": ["AMQP","MQTT","STOMP","XMPP","Kafka"]},

            "host": { "type": "string", "minLength": 1 },
            "broker": { "type": "string", "enum": ["Kafka", "RabbitMQ", "Mosquitto", "EMQX", "hiveMQ"]},
            "topic": { "type": "string", "minLength": 1 },
            
            "end-point": { "type": "string", "minLength": 1 },
            "method": { "type": "string", "enum": ["GET","POST","PUT","PATCH","DELETE"]},
            "sampling-time":{ "type": "string", "minLength": 1 }
          },
          "allOf": [
            {
              "description": "Override por sensor: si el sensor define paradigm=MessageOriented, se valida como MessageOriented.",
              "if": { "required": ["paradigm"], "properties": { "paradigm": { "const": "MessageOriented" } } },
              "then": {
                "required": ["host","topic","protocol","broker"],
                "not": { "anyOf": [{ "required": ["end-point"] }, { "required": ["method"] }, { "required": ["sampling-time"] }] }
              }
            },
            {
              "description": "Override por sensor: si el sensor define paradigm=HTTPCompliant, se valida como HTTPCompliant.",
              "if": { "required": ["paradigm"], "properties": { "paradigm": { "const": "HTTPCompliant" } } },
              "then": {
                "required": ["end-point","method","sampling-time"],
                "not": { "anyOf": [{ "required": ["host"] },{ "required": ["topic"] }, { "required": ["protocol"] }, { "required": ["broker"] }] }
              }
            }
          ]
        }
      },

      "allOf": [
        {
          "description": "Regla global: si config.paradigm=MessageOriented, sensores SIN paradigm heredan MessageOriented.",
          "if": {
                "properties": { "paradigm": { "const": "MessageOriented" } },
                "required": ["paradigm"]
          },
          "then": {
            "patternProperties": {
              "[A-Za-z_][A-Za-z0-9_-]*$": {
                "if": { "not": { "required": ["paradigm"] } },
                "then": {
                  "required": ["topic"],
                  "not": { "anyOf": [{ "required": ["end-point"] }, { "required": ["method"] }, { "required": ["sampling-time"] }] }
                }
              }
            }
          }
        },
        {
          "description": "Regla global: si config.paradigm=HTTPCompliant, sensores SIN paradigm heredan HTTPCompliant.",
          "if": {
                "properties": { "paradigm": { "const": "HTTPCompliant" } },
                "required": ["paradigm"]
          },
          "then": {
            "patternProperties": {
              "[A-Za-z_][A-Za-z0-9_-]*$": {
                "if": { "not": { "required": ["paradigm"] } },
                "then": {
                  "required": ["end-point"],
                  "not": { "anyOf": [{ "required": ["topic"] }, { "required": ["protocol"] }, { "required": ["broker"] }] }
                }
              }
            }
          }
        }
      ]

     
    },

    "iotDataSource": {
        "type": "object",
        "required": ["paradigm","schema"],
        "additionalProperties": false,
        "properties":{
            "format": { "type": "string", "pattern": "^application\\/[A-Za-z_][A-Za-z0-9_-]+$" },
            "host":{ "type": "string", "minLength": 1},
            "schema": { "$ref": "#/definitions/variables" },
            "paradigm": { "type": "string", "enum": ["MessageOriented","HTTPCompliant"]},
            "protocol": { "type": "string", "enum": ["AMQP","MQTT","STOMP","XMPP"]},
            "broker": { "type": "string", "enum": ["Kafka", "RabbitMQ", "Mosquitto", "EMQX", "hiveMQ"]},
            "topic":{ "type": "string", "minLength": 1},
            "end-point": { "type": "string", "minLength": 1},
            "method": { "type": "string", "enum": ["GET","POST","PUT","PATCH","DELETE"]},
            "sampling-time":{ "type": "string", "minLength": 1 }          
        },
        "oneOf":[
          {
            "properties":{ "paradigm": {"const": "MessageOriented" }},
            "required": ["host","protocol", "topic","broker"],
            "not": {"required":["end-point","method","sampling-time"]}
          },
          {
            "properties":{ "paradigm": {"const": "HTTPCompliant" }},
            "required": ["end-point","method","sampling-time"],
            "not": {"required":["host","protocol", "topic","broker"]}
          }
        ]
    },

    "processContext":{
      "type": "object",
      "properties": {
          "engine": { 
                "type": "string", 
                "enum": ["Camunda","Bonita","Activiti","Bizagi","Flowable","jBPM","Signavio"]
          },
            "host": { "type": "string", "minLength": 1 },
            "process-id": { "type": "string", "minLength": 1 }
          }
    },

    "processDataSource": {
      "type": "object",
      "patternProperties": {
        "^[A-Za-z_][A-Za-z0-9_-]+$": {
          "type":"object",
          "additionalProperties": false,
          "required": ["elements"],
          "properties": {
            "format": { "type": "string", "minLength": 1 },
            "elements": { "$ref": "#/definitions/bpmnElement" }
          }
        }
      }   
    },

    "bpmnElement": {
      "type": "object",
      "additionalProperties": false,
      "patternProperties": {
        "^[A-Za-z_][A-Za-z0-9_-]*$": {
          "required": ["type", "events"],
          "additionalProperties": false,
          "properties":{
            "type": { 
                "type": "string", 
                "enum": ["Process","Task","User Task","Service Task","Message","Gateway","Exclusive Gateway"]
            },
            "events": { "$ref": "#/definitions/events" }
          }
        }
      }
    },

    "events": {
      "description": "An event can be a simple name (e.g., 'bacteria_detected') or an object keyed by event name with optional variables.",
      "oneOf": [
          { 
            "type": "array", 
            "minItems": 1, 
            "items":{"type":"string", "minLength": 1} 
          },
          {  
            "$ref": "#/definitions/eventObject" 
          }
      ]
    },

    "eventObject": {
      "type": "object",
      "additionalProperties": false,
      "patternProperties": {
        "^(started|completed|cancelled|interrupted|assigned|executed|triggered|path-evaluation)$": {
          "additionalProperties": false,
          "properties":{
            "variables": { "$ref": "#/definitions/variables" }
          }
        }
      }
    },

    "variables": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/definitions/variable" }
    },

    "variable": {
      "description": "A variable is represented as an object with one mandatory property: { <varName>: <varTypec> } and an optional internal_id.",
      "type": "object",
      "additionalProperties": false,
      "minProperties": 1,
      "maxProperties": 2,
      "properties":{
        "internal-id": {"type":"string"}
      },
      "patternProperties": {
        "^(?!internal-id$)[A-Za-z_][A-Za-z0-9_-]+$": {
          "type": "string",
          "enum": ["string","integer","double","float","boolean", "timeStamp", "date", "dateTime", "number"],
          "minLength": 1
        }
      },
      "allOf": [
        {
          "description": "Require at least one dynamic (non 'internal-id') property.",
          "not": {
            "required": ["internal-id"],
            "maxProperties": 1
          }
        }
      ]
    }

  }
}